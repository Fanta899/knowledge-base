# C++20 std::ranges æ ¸å¿ƒæ•´ç†

> é¢å‘ï¼š**é•¿æœŸçŸ¥è¯†åº“ / é¢è¯• / å·¥ç¨‹å®è·µ**

---

## 1. std::ranges æ˜¯ä»€ä¹ˆï¼ˆWhatï¼‰

`std::ranges` æ˜¯ C++20 å¼•å…¥çš„ä¸€å¥— **åŸºäºâ€œåŒºé—´ï¼ˆrangeï¼‰â€çš„ç®—æ³•ä¸è§†å›¾ï¼ˆviewï¼‰ä½“ç³»**ï¼Œ
ç”¨äºï¼š

* æé«˜ç®—æ³•å¯è¯»æ€§
* é™ä½é”™è¯¯ç‡ï¼ˆè¿­ä»£å™¨ä¸åŒ¹é…ï¼‰
* æ”¯æŒ **æƒ°æ€§ï¼ˆå»¶è¿Ÿï¼‰è®¡ç®—**

ä¸€å¥è¯ï¼š

> **ranges = ç®—æ³• + çº¦æŸ + è§†å›¾ï¼ˆviewsï¼‰**

---

## 2. ä¸ºä»€ä¹ˆè¦æœ‰ rangesï¼ˆWhyï¼‰

### 2.1 ä¼ ç»Ÿ STL çš„é—®é¢˜

```cpp
std::vector<int> v{1,2,3,4,5};
std::copy_if(v.begin(), v.end(), out.begin(), pred);
```

é—®é¢˜ï¼š

* begin / end å®¹æ˜“å†™é”™
* ç®—æ³•ç»„åˆå›°éš¾
* ä¸­é—´ç»“æœå¿…é¡»è½åœ°æˆå®¹å™¨

---

### 2.2 ranges è§£å†³äº†ä»€ä¹ˆ

```cpp
std::ranges::copy_if(v, out, pred);
```

æˆ–è€…ï¼š

```cpp
auto r = v | std::views::filter(pred) | std::views::take(3);
```

ä¼˜åŠ¿ï¼š

* ä¸æš´éœ²è¿­ä»£å™¨
* æ”¯æŒç®¡é“å¼ç»„åˆ
* ä¸äº§ç”Ÿä¸­é—´å®¹å™¨ï¼ˆviewï¼‰

---

## 3. æ ¸å¿ƒæ¦‚å¿µæ€»è§ˆ

| æ¦‚å¿µ        | è¯´æ˜                              |
| --------- | ------------------------------- |
| range     | å¯éå†çš„å¯¹è±¡ï¼ˆæœ‰ begin/endï¼‰             |
| view      | **ä¸æ‹¥æœ‰æ•°æ®**çš„ rangeï¼ˆæƒ°æ€§ï¼‰            |
| algorithm | æ¥å— range çš„ç®—æ³•                    |
| adaptor   | ç”Ÿæˆ view çš„å·¥å…·ï¼ˆfilter / transformï¼‰ |

---

## 4. view ä¸ºä»€ä¹ˆæ˜¯â€œå»¶è¿Ÿæ‰§è¡Œâ€ï¼ˆé‡ç‚¹ï¼‰

### 4.1 ç»“è®º

> **view æœ¬èº«ä¸æ‰§è¡Œä»»ä½•é€»è¾‘**ï¼Œ
> **åªæœ‰åœ¨éå†ï¼ˆiterationï¼‰å‘ç”Ÿæ—¶æ‰æ‰§è¡Œ**ã€‚

---

### 4.2 ç¤ºä¾‹è¯´æ˜

```cpp
auto r = v | std::views::filter([](int x) {
    std::cout << "filter " << x << '\n';
    return x % 2 == 0;
});
```

æ­¤æ—¶ï¼š

* âŒ ä¸ä¼šæ‰“å°ä»»ä½•ä¸œè¥¿
* åªæ˜¯æ„é€ äº†ä¸€ä¸ª view å¯¹è±¡

---

### 4.3 çœŸæ­£æ‰§è¡Œçš„æ—¶æœº

```cpp
for (int x : r) {
    std::cout << x << '\n';
}
```

è¾“å‡ºæ—¶ï¼š

* æ¯æ¬¡ `++iterator`
* è§¦å‘ filter åˆ¤æ–­

ğŸ“Œ **æ‰§è¡Œå‘ç”Ÿåœ¨ç®—æ³• / for-range ä¸­**

---

## 5. view â‰  containerï¼ˆéå¸¸é‡è¦ï¼‰

| å¯¹æ¯”     | view | container |
| ------ | ---- | --------- |
| æ˜¯å¦æ‹¥æœ‰æ•°æ® | âŒ    | âœ…         |
| æ˜¯å¦æ‹·è´å…ƒç´  | âŒ    | âœ…         |
| ç”Ÿå‘½å‘¨æœŸ   | ä¾èµ–æº  | è‡ªæŒ        |
| æ˜¯å¦æƒ°æ€§   | âœ…    | âŒ         |

---

## 6. ç”Ÿå‘½å‘¨æœŸé™·é˜±ï¼ˆé«˜é¢‘å‘ï¼‰

### 6.1 é”™è¯¯ç¤ºä¾‹

```cpp
auto make_view() {
    std::vector<int> v{1,2,3,4};
    return v | std::views::filter([](int x){ return x > 2; });
}
```

é—®é¢˜ï¼š

* è¿”å›çš„ view å¼•ç”¨å·²é”€æ¯çš„ `v`
* **æ‚¬ç©ºå¼•ç”¨ï¼ˆUBï¼‰**

---

### 6.2 æ­£ç¡®æ–¹å¼

```cpp
auto v = std::vector<int>{1,2,3,4};
auto r = v | std::views::filter(pred);
```

æˆ–ï¼š

```cpp
auto r = std::views::iota(1, 10)
       | std::views::filter(pred);
```

---

## 7. view çš„å¸¸è§ç»„åˆæ¨¡å¼

### 7.1 filter + transform

```cpp
auto r = v
  | std::views::filter([](int x){ return x % 2 == 0; })
  | std::views::transform([](int x){ return x * x; });
```

---

### 7.2 take / drop / reverse

```cpp
auto r = v
  | std::views::drop(2)
  | std::views::take(3)
  | std::views::reverse;
```

---

## 8. ranges ç®—æ³• vs ä¼ ç»Ÿç®—æ³•

### 8.1 ranges::for_each

```cpp
std::ranges::for_each(v, [](int x){
    std::cout << x << '\n';
});
```

ç­‰ä»·äºï¼š

```cpp
std::for_each(v.begin(), v.end(), ...);
```

ä½†ï¼š

* ä¸éœ€è¦ begin/end
* çº¦æŸæ›´ä¸¥æ ¼

---

## 9. ranges::copy èƒ½æ“ä½œä»€ä¹ˆï¼Ÿ

```cpp
std::ranges::copy(r, out);
```

è¦æ±‚ï¼š

* `r` æ˜¯ input_range
* `out` æ»¡è¶³ output_iterator

ğŸ“Œ **view å®Œå…¨å¯ä»¥ä½œä¸ºè¾“å…¥**

---

## 10. ä»€ä¹ˆæ—¶å€™ä¸ç”¨ viewï¼ˆå·¥ç¨‹ç»éªŒï¼‰

ä¸é€‚åˆçš„æƒ…å†µï¼š

* å¤šæ¬¡éå†åŒä¸€ç»“æœ
* éœ€è¦éšæœºè®¿é—®
* éœ€è¦ç¼“å­˜ä¸­é—´ç»“æœ

ğŸ‘‰ æ­¤æ—¶åº”ï¼š

```cpp
std::vector<int> result(r.begin(), r.end());
```

---

## 11. é¢è¯•é«˜é¢‘æ€»ç»“

* view æ˜¯ä¸æ˜¯ç«‹å³æ‰§è¡Œï¼Ÿ â†’ âŒ
* view æ˜¯å¦æ‹¥æœ‰æ•°æ®ï¼Ÿ â†’ âŒ
* æ‰§è¡Œå‘ç”Ÿåœ¨å“ªé‡Œï¼Ÿ â†’ **ç®—æ³• / éå†æ—¶**
* æœ€å¤§çš„å‘ï¼Ÿ â†’ **ç”Ÿå‘½å‘¨æœŸ**

---

## 12. ä¸€å¥è¯æ€»ç»“

> **std::ranges = ç”¨æƒ°æ€§ view ç»„åˆæ•°æ®æµï¼Œç”¨ç®—æ³•è§¦å‘æ‰§è¡Œ**

---

## Related

* [[cpp/memory_model]]
* [[ä¸ºä»€ä¹ˆ_view_æ˜¯å»¶è¿Ÿæ‰§è¡Œ]]
